<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIGC任务生产平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen" x-data="taskManager()">
    <!-- 环境选择界面 -->
    <div x-show="currentView === 'envSelect'" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl w-full mx-4">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-primary-100 rounded-full mb-4">
                    <i class="fas fa-server text-5xl text-primary-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">选择运行环境</h1>
                <p class="text-gray-600">请选择要操作的环境，不同环境的任务和数据是独立的</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 灰度环境 -->
                <button @click="selectEnvironment('gray')" 
                        class="group relative overflow-hidden bg-gradient-to-br from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 border-2 border-orange-300 rounded-xl p-8 transition-all duration-300 hover:shadow-xl hover:scale-105">
                    <div class="text-center">
                        <div class="inline-block p-4 bg-orange-200 rounded-full mb-4 group-hover:bg-orange-300 transition-colors">
                            <i class="fas fa-flask text-4xl text-orange-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-orange-900 mb-2">灰度环境</h2>
                        <p class="text-orange-700 text-sm">测试和验证新功能</p>
                        <div class="mt-4 inline-flex items-center text-orange-600 font-medium">
                            <span>进入灰度</span>
                            <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </div>
                </button>
                
                <!-- 线上环境 -->
                <button @click="selectEnvironment('production')" 
                        class="group relative overflow-hidden bg-gradient-to-br from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 border-2 border-green-300 rounded-xl p-8 transition-all duration-300 hover:shadow-xl hover:scale-105">
                    <div class="text-center">
                        <div class="inline-block p-4 bg-green-200 rounded-full mb-4 group-hover:bg-green-300 transition-colors">
                            <i class="fas fa-rocket text-4xl text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-green-900 mb-2">线上环境</h2>
                        <p class="text-green-700 text-sm">正式生产环境</p>
                        <div class="mt-4 inline-flex items-center text-green-600 font-medium">
                            <span>进入线上</span>
                            <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </div>
                </button>
            </div>
            
            <div class="mt-8 text-center text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                选择后可在导航栏切换环境
            </div>
        </div>
    </div>

    <!-- 导航栏 -->
    <nav x-show="currentView !== 'envSelect'" class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        <i class="fas fa-robot text-2xl text-primary-600"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">AIGC任务生产平台</h1>
                        <p class="text-sm text-gray-500">智能任务配置与管理</p>
                    </div>
                    <!-- 当前环境显示 -->
                    <div class="ml-6 px-4 py-2 rounded-lg border-2" 
                         :class="currentEnvironment === 'gray' ? 'bg-orange-50 border-orange-300' : 'bg-green-50 border-green-300'">
                        <div class="flex items-center space-x-2">
                            <i class="fas" :class="currentEnvironment === 'gray' ? 'fa-flask text-orange-600' : 'fa-rocket text-green-600'"></i>
                            <span class="font-medium" :class="currentEnvironment === 'gray' ? 'text-orange-900' : 'text-green-900'" 
                                  x-text="currentEnvironment === 'gray' ? '灰度环境' : '线上环境'"></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- 环境切换按钮 -->
                    <button @click="switchEnvironment()" 
                            class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-lg flex items-center space-x-2 transition-colors border border-gray-300 hover:border-gray-400">
                        <i class="fas fa-exchange-alt"></i>
                        <span>切换环境</span>
                    </button>
                    <button x-show="currentView === 'detail'" @click="backToList()" 
                            class="text-gray-600 hover:text-gray-900 px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回列表</span>
                    </button>
                    <button x-show="currentView === 'list'" @click="showCreateModal = true" 
                            class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i class="fas fa-plus"></i>
                        <span>创建任务</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 - 任务列表视图 -->
    <main x-show="currentView === 'list'" class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- 统计卡片 - 轻量化设计 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">总任务数</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="getCurrentEnvironmentTasksCount()"></p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
                        <i class="fas fa-tasks text-blue-500"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">运行中</p>
                        <p class="text-2xl font-semibold text-blue-600" x-text="getRunningTasks()"></p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
                        <i class="fas fa-play-circle text-blue-500"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">等待中</p>
                        <p class="text-2xl font-semibold text-yellow-600" x-text="getPendingTasks()"></p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-500"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务列表 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">任务列表</h2>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex space-x-1 bg-gray-100 rounded-lg p-1">
                        <button @click="taskStatusFilter = 'all'" 
                                :class="taskStatusFilter === 'all' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                            全部
                        </button>
                        <button @click="taskStatusFilter = 'running'" 
                                :class="taskStatusFilter === 'running' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                            运行中
                        </button>
                        <button @click="taskStatusFilter = 'completed'" 
                                :class="taskStatusFilter === 'completed' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                            已完成
                        </button>
                        <button @click="taskStatusFilter = 'pending'" 
                                :class="taskStatusFilter === 'pending' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                            等待中
                        </button>
                    </div>
                    <div>
                        <input type="text" x-model="taskSearchKeyword" 
                               placeholder="搜索任务名称或描述..."
                               class="px-4 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent w-64">
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任务名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cases统计</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="task in getFilteredTasksPage()" :key="task.id">
                            <tr class="hover:bg-gray-50 cursor-pointer" @click="viewTaskDetail(task.id)">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center">
                                                <i class="fas fa-robot text-primary-600"></i>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900" x-text="task.name"></div>
                                            <div class="text-sm text-gray-500" x-text="task.description"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="getTaskStatusClass(task)" x-text="getTaskStatusText(task)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div class="flex items-center space-x-4">
                                        <span class="text-green-600"><i class="fas fa-check-circle"></i> <span x-text="getTaskCaseStats(task.id).success"></span></span>
                                        <span class="text-red-600"><i class="fas fa-times-circle"></i> <span x-text="getTaskCaseStats(task.id).failed"></span></span>
                                        <span class="text-gray-600"><i class="fas fa-list"></i> <span x-text="getTaskCaseStats(task.id).total"></span></span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(task.createdAt)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" @click.stop>
                                    <div class="flex space-x-2">
                                        <button @click="toggleTaskCompletion(task)" 
                                                x-show="!task.isCompleted"
                                                class="text-green-600 hover:text-green-900"
                                                title="标记为已完成">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button @click="editTask(task)" 
                                                class="text-yellow-600 hover:text-yellow-900"
                                                title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="deleteTask(task.id)" 
                                                class="text-red-600 hover:text-red-900"
                                                title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <!-- 空状态提示 -->
                <div x-show="getFilteredTasks().length === 0" class="py-16 text-center">
                    <div class="text-gray-400">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p class="text-lg font-medium text-gray-500">暂无任务</p>
                        <p class="text-sm text-gray-400 mt-2">点击右上角"创建任务"按钮开始</p>
                    </div>
                </div>
            </div>
            <!-- 任务列表分页 -->
            <div x-show="getFilteredTasks().length > 0" class="px-6 py-4 border-t border-gray-200 flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    共 <span class="font-semibold" x-text="getFilteredTasks().length"></span> 个任务
                </div>
                <div class="flex items-center space-x-2">
                    <button @click="taskCurrentPage = Math.max(1, taskCurrentPage - 1)" 
                            :disabled="taskCurrentPage === 1"
                            :class="taskCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
                            class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                        上一页
                    </button>
                    <span class="text-sm text-gray-700">
                        第 <span class="font-semibold" x-text="taskCurrentPage"></span> / <span x-text="getTaskTotalPages()"></span> 页
                    </span>
                    <button @click="taskCurrentPage = Math.min(getTaskTotalPages(), taskCurrentPage + 1)" 
                            :disabled="taskCurrentPage === getTaskTotalPages()"
                            :class="taskCurrentPage === getTaskTotalPages() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
                            class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                        下一页
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 任务详情视图 -->
    <main x-show="currentView === 'detail'" class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <template x-if="selectedTask">
            <div>
                <!-- 任务概览卡片 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" x-text="selectedTask.name"></h2>
                            <p class="text-gray-600 mt-1" x-text="selectedTask.description"></p>
                            <div class="mt-4 flex items-center space-x-4">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                      :class="getStatusClass(selectedTask.status)" x-text="getStatusText(selectedTask.status)"></span>
                                <span class="text-sm text-gray-500">创建于 <span x-text="formatDate(selectedTask.createdAt)"></span></span>
                            </div>
                        </div>
                        <button @click="showUploadModal = true"
                                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-upload"></i>
                            <span>上传Cases</span>
                        </button>
                    </div>
                </div>

                <!-- Case统计卡片 - 轻量化设计 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">总Cases</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="getCompletedCasesCount()"></p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
                                <i class="fas fa-list text-blue-500"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">成功</p>
                                <p class="text-2xl font-semibold text-green-600" x-text="getTaskCaseStats(selectedTask.id).success"></p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center">
                                <i class="fas fa-check-circle text-green-500"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">失败</p>
                                <p class="text-2xl font-semibold text-red-600" x-text="getTaskCaseStats(selectedTask.id).failed"></p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center">
                                <i class="fas fa-times-circle text-red-500"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Case列表 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Cases 列表</h3>
                            <div class="flex space-x-2">
                                <button @click="exportCases()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm font-medium flex items-center space-x-1">
                                    <i class="fas fa-download"></i>
                                    <span>导出</span>
                                </button>
                                <button x-show="caseFilter === 'failed'" @click="regenerateAllFailed()" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-medium flex items-center space-x-1"
                                        :disabled="getTaskCaseStats(selectedTask.id).failed === 0">
                                    <i class="fas fa-redo"></i>
                                    <span>重试所有失败</span>
                                </button>
                            </div>
                        </div>
                        <!-- 进度条 -->
                        <div x-show="taskProgress.show && selectedTask" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-blue-900">处理进度</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-blue-700" x-text="'已处理 ' + taskProgress.processed + ' / 总共 ' + taskProgress.total + ' 条'"></span>
                                    <button @click="stopProcessing()" 
                                            x-show="!taskProgress.stopped && taskProgress.processing > 0"
                                            class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md">
                                        <i class="fas fa-stop"></i> 停止
                                    </button>
                                    <button @click="continueProcessing()" 
                                            x-show="taskProgress.stopped && (taskProgress.total - taskProgress.processed) > 0"
                                            class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md">
                                        <i class="fas fa-play"></i> 继续
                                    </button>
                                    <button @click="deletePendingCases()" 
                                            x-show="taskProgress.stopped && (taskProgress.total - taskProgress.processed) > 0"
                                            class="text-xs bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md">
                                        <i class="fas fa-trash"></i> 删除待处理
                                    </button>
                                </div>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                     :style="'width: ' + (taskProgress.total > 0 ? (taskProgress.processed / taskProgress.total * 100) : 0) + '%'"></div>
                            </div>
                            <div class="mt-2 flex justify-between items-center text-xs text-blue-600">
                                <div>
                                    <span>成功: </span><span class="font-semibold text-green-600" x-text="taskProgress.success"></span>
                                    <span class="mx-2">|</span>
                                    <span>失败: </span><span class="font-semibold text-red-600" x-text="taskProgress.failed"></span>
                                    <span class="mx-2">|</span>
                                    <span>剩余: </span><span class="font-semibold text-orange-600" x-text="taskProgress.total - taskProgress.processed"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex space-x-1 bg-gray-100 rounded-lg p-1">
                                <button @click="caseFilter = 'all'; currentPage = 1" 
                                        :class="caseFilter === 'all' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                        class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                                    全部
                                </button>
                                <button @click="caseFilter = 'success'; currentPage = 1" 
                                        :class="caseFilter === 'success' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                        class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                                    成功
                                </button>
                                <button @click="caseFilter = 'failed'; currentPage = 1" 
                                        :class="caseFilter === 'failed' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'"
                                        class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-700 transition-all">
                                    失败
                                </button>
                            </div>
                            <div class="flex items-center space-x-4">
                                <input type="text" x-model="searchKeyword" @input="currentPage = 1"
                                       placeholder="搜索Case ID或参数..."
                                       class="px-4 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent w-64">
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Case ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">入参</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">重试次数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="caseItem in getFilteredCases()" :key="caseItem.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="'#' + caseItem.id"></td>
                                        <td class="px-6 py-4 text-sm text-gray-900">
                                            <div class="max-w-xs truncate" x-text="formatInputParams(caseItem.inputParams)"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                  :class="getCaseStatusClass(caseItem.status)" x-text="getCaseStatusText(caseItem.status)"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <span x-text="caseItem.retryCount + '/' + caseItem.maxRetries"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(caseItem.createdAt)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <div class="flex space-x-2">
                                                <button @click="viewCaseDetail(caseItem)" 
                                                        class="text-primary-600 hover:text-primary-900"
                                                        title="查看详情">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button @click="regenerateCase(caseItem.id)" 
                                                        class="text-green-600 hover:text-green-900"
                                                        title="重新生成"
                                                        :disabled="caseItem.status === 'processing'">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                                <button @click="clearCaseEnvironmentData(caseItem.id)" 
                                                        class="text-orange-600 hover:text-orange-900"
                                                        title="清除环境数据">
                                                    <i class="fas fa-broom"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <!-- 空状态提示 -->
                        <div x-show="getFilteredCases().length === 0" class="py-16 text-center">
                            <div class="text-gray-400">
                                <i class="fas fa-inbox text-6xl mb-4"></i>
                                <p class="text-lg font-medium text-gray-500" x-text="caseFilter === 'success' ? '暂无成功的Case' : (caseFilter === 'failed' ? '暂无失败的Case' : '暂无Case数据')"></p>
                                <p class="text-sm text-gray-400 mt-2" x-show="caseFilter === 'all'">点击"上传Cases"按钮开始添加</p>
                            </div>
                        </div>
                    </div>
                    <!-- 分页和统计 -->
                    <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            <span x-text="getCurrentFilterText()"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="currentPage = Math.max(1, currentPage - 1)" 
                                    :disabled="currentPage === 1"
                                    :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                上一页
                            </button>
                            <span class="text-sm text-gray-700">
                                第 <span class="font-semibold" x-text="currentPage"></span> / <span x-text="getTotalPages()"></span> 页
                            </span>
                            <button @click="currentPage = Math.min(getTotalPages(), currentPage + 1)" 
                                    :disabled="currentPage === getTotalPages()"
                                    :class="currentPage === getTotalPages() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                下一页
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <!-- 创建/编辑任务模态框 -->
    <div x-show="showCreateModal || showEditModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeModal()"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <form @submit.prevent="saveTask()">
                    <div class="bg-white px-6 pt-6 pb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900" x-text="showEditModal ? '编辑任务' : '创建新任务'"></h3>
                            <button type="button" @click="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- 任务基本信息 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">任务名称</label>
                                <input type="text" x-model="currentTask.name" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">任务描述</label>
                                <textarea x-model="currentTask.description" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"></textarea>
                            </div>

                            <!-- Dify配置 -->
                            <div class="border-t pt-6">
                                <h4 class="text-md font-medium text-gray-900 mb-4">Dify API 配置</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">API URL</label>
                                        <input type="url" x-model="currentTask.difyUrl" required
                                               placeholder="https://api.dify.ai/v1/..."
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                                        <input type="password" x-model="currentTask.difyKey" required
                                               placeholder="输入您的Dify API Key"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                </div>
                            </div>

                            <!-- 入参字段配置 -->
                            <div class="border-t pt-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-md font-medium text-gray-900">入参字段定义</h4>
                                    <button type="button" @click="addInputField()" 
                                            class="text-primary-600 hover:text-primary-800 text-sm flex items-center space-x-1">
                                        <i class="fas fa-plus"></i>
                                        <span>添加入参</span>
                                    </button>
                                </div>
                                <div class="space-y-3">
                                    <div x-show="currentTask.inputFields.length === 0" class="text-sm text-gray-500 text-center py-4 bg-gray-50 rounded-md">
                                        暂无入参字段，点击"添加入参"开始配置
                                    </div>
                                    <template x-for="(field, index) in currentTask.inputFields" :key="index">
                                        <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-md">
                                            <div class="flex-1 grid grid-cols-2 gap-2">
                                                <input type="text" x-model="field.name" placeholder="字段名称（如：hotel_id）" required
                                                       class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                                <select x-model="field.type" required
                                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                                    <option value="">选择类型</option>
                                                    <option value="string">String (字符串)</option>
                                                    <option value="number">Number (数字)</option>
                                                    <option value="boolean">Boolean (布尔)</option>
                                                    <option value="array">Array (数组)</option>
                                                    <option value="object">Object (对象)</option>
                                                </select>
                                            </div>
                                            <button type="button" @click="removeInputField(index)" 
                                                    class="text-red-600 hover:text-red-800 p-2">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- 出参字段配置 -->
                            <div class="border-t pt-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-md font-medium text-gray-900">出参字段定义</h4>
                                    <button type="button" @click="addOutputField()" 
                                            class="text-primary-600 hover:text-primary-800 text-sm flex items-center space-x-1">
                                        <i class="fas fa-plus"></i>
                                        <span>添加出参</span>
                                    </button>
                                </div>
                                <div class="space-y-3">
                                    <div x-show="currentTask.outputFields.length === 0" class="text-sm text-gray-500 text-center py-4 bg-gray-50 rounded-md">
                                        暂无出参字段，点击"添加出参"开始配置
                                    </div>
                                    <template x-for="(field, index) in currentTask.outputFields" :key="index">
                                        <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-md">
                                            <div class="flex-1 grid grid-cols-2 gap-2">
                                                <input type="text" x-model="field.name" placeholder="字段名称（如：result）" required
                                                       class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                                <select x-model="field.type" required
                                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                                    <option value="">选择类型</option>
                                                    <option value="string">String (字符串)</option>
                                                    <option value="number">Number (数字)</option>
                                                    <option value="boolean">Boolean (布尔)</option>
                                                    <option value="array">Array (数组)</option>
                                                    <option value="object">Object (对象)</option>
                                                </select>
                                            </div>
                                            <button type="button" @click="removeOutputField(index)" 
                                                    class="text-red-600 hover:text-red-800 p-2">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                        <button type="button" @click="closeModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            取消
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-primary-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span x-text="showEditModal ? '更新任务' : '创建任务'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 上传Cases模态框 -->
    <div x-show="showUploadModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showUploadModal = false"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form @submit.prevent="uploadCases()">
                    <div class="bg-white px-6 pt-6 pb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900">上传Cases批次</h3>
                            <button type="button" @click="showUploadModal = false" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">失败重试次数</label>
                                    <input type="number" x-model="uploadBatch.maxRetries" min="0" max="10" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">并发次数</label>
                                    <input type="number" x-model="uploadBatch.concurrency" min="1" max="20" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">上传Excel文件</label>
                                <div x-show="!uploadBatch.fileName" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-primary-400 transition-colors">
                                    <div class="space-y-1 text-center">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500">
                                                <span>选择Excel文件</span>
                                                <input id="file-upload" type="file" accept=".xlsx,.xls" 
                                                       @change="handleFileUpload($event)" class="sr-only">
                                            </label>
                                        </div>
                                        <p class="text-xs text-gray-500">支持 .xlsx, .xls 格式</p>
                                    </div>
                                </div>
                                <div x-show="uploadBatch.fileName" class="mt-1 p-4 bg-green-50 border-2 border-green-300 rounded-md">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-file-excel text-green-600 text-2xl"></i>
                                            <div>
                                                <p class="text-sm font-medium text-green-900" x-text="uploadBatch.fileName"></p>
                                                <p class="text-xs text-green-700" x-text="uploadBatch.rowCount + ' 行数据'"></p>
                                            </div>
                                        </div>
                                        <button type="button" @click="removeUploadedFile()" 
                                                class="text-red-600 hover:text-red-800 p-2"
                                                title="删除文件">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                        <button type="button" @click="showUploadModal = false" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-primary-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-primary-700">
                            上传并处理
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Case详情模态框 -->
    <div x-show="showCaseDetailModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showCaseDetailModal = false"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <template x-if="selectedCase">
                    <div>
                        <div class="bg-white px-6 pt-6 pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Case 详情</h3>
                                <button type="button" @click="showCaseDetailModal = false" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Case基本信息 -->
                                <div class="bg-gray-50 p-4 rounded-md">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">Case ID</p>
                                            <p class="text-sm text-gray-900 font-mono" x-text="'#' + selectedCase.id"></p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">状态</p>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                  :class="getCaseStatusClass(selectedCase.status)" x-text="getCaseStatusText(selectedCase.status)"></span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">重试次数</p>
                                            <p class="text-sm text-gray-900" x-text="selectedCase.retryCount + '/' + selectedCase.maxRetries"></p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">创建时间</p>
                                            <p class="text-sm text-gray-900" x-text="formatDate(selectedCase.createdAt)"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 入参 -->
                                <div>
                                    <h4 class="text-md font-medium text-gray-900 mb-2">入参数据</h4>
                                    <pre class="bg-gray-900 text-green-400 p-4 rounded-md overflow-x-auto text-sm" x-text="JSON.stringify(selectedCase.inputParams, null, 2)"></pre>
                                </div>

                                <!-- 出参 -->
                                <div x-show="selectedCase.outputData">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-medium text-gray-900">输出结果</h4>
                                        <button @click="toggleEditOutput()" 
                                                class="text-sm text-primary-600 hover:text-primary-800 flex items-center space-x-1">
                                            <i class="fas" :class="editingOutput ? 'fa-eye' : 'fa-edit'"></i>
                                            <span x-text="editingOutput ? '预览模式' : '编辑模式'"></span>
                                        </button>
                                    </div>
                                    <!-- 预览模式 -->
                                    <pre x-show="!editingOutput" class="bg-gray-900 text-blue-400 p-4 rounded-md overflow-x-auto text-sm" x-text="JSON.stringify(selectedCase.outputData, null, 2)"></pre>
                                    <!-- 编辑模式 -->
                                    <div x-show="editingOutput">
                                        <textarea x-model="editingOutputData" 
                                                  rows="10"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                                                  placeholder="JSON格式的输出数据"></textarea>
                                        <div class="mt-2 flex justify-end space-x-2">
                                            <button @click="cancelEditOutput()" 
                                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                                取消
                                            </button>
                                            <button @click="saveEditOutput()" 
                                                    class="px-3 py-1 text-sm bg-primary-600 text-white rounded-md hover:bg-primary-700">
                                                保存修改
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 错误信息 -->
                                <div x-show="selectedCase.error">
                                    <h4 class="text-md font-medium text-red-600 mb-2">错误信息</h4>
                                    <div class="bg-red-50 border border-red-200 p-4 rounded-md text-sm text-red-800" x-text="selectedCase.error"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 px-6 py-3 flex justify-between items-center">
                            <button @click="clearCaseEnvironmentData(selectedCase.id); showCaseDetailModal = false" 
                                    class="px-4 py-2 bg-orange-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-orange-700">
                                <i class="fas fa-broom"></i> 清除环境数据
                            </button>
                            <div class="flex space-x-3">
                                <button @click="showCaseDetailModal = false" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    关闭
                                </button>
                                <button @click="regenerateCase(selectedCase.id); showCaseDetailModal = false" 
                                        class="px-4 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700">
                                    <i class="fas fa-redo"></i> 重新生成
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- 完成统计弹窗 -->
    <div x-show="showCompletionModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-center mb-4">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                            <i class="fas fa-check-circle text-2xl text-green-600"></i>
                        </div>
                    </div>
                    <div class="text-center">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">处理完成</h3>
                        <div class="space-y-3">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">总Cases</p>
                                        <p class="text-2xl font-bold text-gray-900" x-text="completionStats.total"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">成功</p>
                                        <p class="text-2xl font-bold text-green-600" x-text="completionStats.success"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">失败</p>
                                        <p class="text-2xl font-bold text-red-600" x-text="completionStats.failed"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 p-3 rounded-md">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    成功率: <span class="font-semibold" x-text="getSuccessRate() + '%'"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-6 py-3 flex justify-center">
                    <button @click="showCompletionModal = false" 
                            class="px-6 py-2 bg-primary-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        确定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function taskManager() {
            return {
                // 视图状态
                currentView: 'envSelect', // 'envSelect', 'list' or 'detail'
                currentEnvironment: null, // 'gray' or 'production'
                
                // 任务数据
                tasks: [
                    {
                        id: 1,
                        name: '内容生成任务',
                        description: '批量生成产品描述内容',
                        difyUrl: 'https://api.dify.ai/v1/chat-messages',
                        difyKey: 'sk-***',
                        maxRetries: 3,
                        retryCount: 1,
                        inputFields: [
                            { name: 'hotel_id', type: 'string' },
                            { name: 'foreign', type: 'string' }
                        ],
                        outputFields: [
                            { name: 'description', type: 'string' },
                            { name: 'keywords', type: 'array' }
                        ],
                        isCompleted: false,
                        environment: 'gray', // 灰度环境任务
                        createdAt: new Date('2024-01-15T10:30:00')
                    },
                    {
                        id: 2,
                        name: '线上内容生成',
                        description: '正式环境的内容生成任务',
                        difyUrl: 'https://api.dify.ai/v1/chat-messages',
                        difyKey: 'sk-prod-***',
                        maxRetries: 3,
                        retryCount: 0,
                        inputFields: [
                            { name: 'hotel_id', type: 'string' },
                            { name: 'foreign', type: 'string' }
                        ],
                        outputFields: [
                            { name: 'description', type: 'string' },
                            { name: 'keywords', type: 'array' }
                        ],
                        isCompleted: false,
                        environment: 'production', // 线上环境任务
                        createdAt: new Date('2024-01-16T09:00:00')
                    }
                ],

                // Cases数据
                cases: [
                    {
                        id: 1001,
                        taskId: 1,
                        batchName: '2024年1月第1批',
                        inputParams: { hotel_id: 'H001', foreign: 'yes' },
                        outputData: { description: '优质酒店服务...', keywords: ['酒店', '服务', '国际'] },
                        status: 'success',
                        retryCount: 0,
                        maxRetries: 3,
                        createdAt: new Date('2024-01-15T11:00:00'),
                        completedAt: new Date('2024-01-15T11:00:15'),
                        error: null
                    },
                    {
                        id: 1002,
                        taskId: 1,
                        batchName: '2024年1月第1批',
                        inputParams: { hotel_id: 'H002', foreign: 'no' },
                        outputData: null,
                        status: 'failed',
                        retryCount: 3,
                        maxRetries: 3,
                        createdAt: new Date('2024-01-15T11:00:00'),
                        completedAt: null,
                        error: 'API调用超时'
                    },
                    {
                        id: 1003,
                        taskId: 1,
                        batchName: '2024年1月第1批',
                        inputParams: { hotel_id: 'H003', foreign: 'yes' },
                        outputData: null,
                        status: 'processing',
                        retryCount: 1,
                        maxRetries: 3,
                        createdAt: new Date('2024-01-15T11:01:00'),
                        completedAt: null,
                        error: null
                    }
                ],

                // 模态框状态
                showCreateModal: false,
                showEditModal: false,
                showUploadModal: false,
                showCaseDetailModal: false,
                showCompletionModal: false,

                // 当前编辑的任务
                currentTask: {
                    name: '',
                    description: '',
                    difyUrl: '',
                    difyKey: '',
                    inputFields: [],
                    outputFields: []
                },
                editingTaskId: null,

                // 选中的任务和Case
                selectedTask: null,
                selectedCase: null,

                // 编辑输出数据
                editingOutput: false,
                editingOutputData: '',

                // 完成统计
                completionStats: {
                    total: 0,
                    success: 0,
                    failed: 0
                },

                // 任务列表过滤器
                taskStatusFilter: 'all',
                taskSearchKeyword: '',

                // Case过滤器和搜索
                caseFilter: 'all',
                searchKeyword: '',
                currentPage: 1,
                pageSize: 10,

                // 任务列表分页
                taskCurrentPage: 1,
                taskPageSize: 10,

                // 上传批次
                uploadBatch: {
                    maxRetries: 3,
                    concurrency: 5,
                    fileName: '',
                    rowCount: 0,
                    data: []
                },

                // 任务进度
                taskProgress: {
                    show: false,
                    total: 0,
                    processed: 0,
                    success: 0,
                    failed: 0,
                    processing: 0,
                    stopped: false
                },

                // 获取过滤后的任务列表（不分页）
                getFilteredTasks() {
                    // 只获取当前环境的任务
                    let filteredTasks = this.tasks.filter(task => task.environment === this.currentEnvironment);
                    
                    // 按创建时间倒序排列（最新的在最上面）
                    filteredTasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // 按状态过滤
                    if (this.taskStatusFilter !== 'all') {
                        filteredTasks = filteredTasks.filter(task => {
                            const actualStatus = this.getTaskActualStatus(task);
                            return actualStatus === this.taskStatusFilter;
                        });
                    }
                    
                    // 按关键词搜索
                    if (this.taskSearchKeyword.trim()) {
                        const keyword = this.taskSearchKeyword.toLowerCase();
                        filteredTasks = filteredTasks.filter(task => {
                            return task.name.toLowerCase().includes(keyword) || 
                                   (task.description && task.description.toLowerCase().includes(keyword));
                        });
                    }
                    
                    return filteredTasks;
                },

                // 获取当前页的任务列表（分页）
                getFilteredTasksPage() {
                    const filteredTasks = this.getFilteredTasks();
                    const start = (this.taskCurrentPage - 1) * this.taskPageSize;
                    const end = start + this.taskPageSize;
                    return filteredTasks.slice(start, end);
                },

                // 获取任务总页数
                getTaskTotalPages() {
                    const total = this.getFilteredTasks().length;
                    return Math.max(1, Math.ceil(total / this.taskPageSize));
                },

                // 获取任务统计（只统计当前环境的任务）
                getCurrentEnvironmentTasksCount() {
                    return this.tasks.filter(task => task.environment === this.currentEnvironment).length;
                },

                getRunningTasks() {
                    return this.tasks.filter(task => 
                        task.environment === this.currentEnvironment && 
                        this.getTaskActualStatus(task) === 'running'
                    ).length;
                },

                getPendingTasks() {
                    return this.tasks.filter(task => 
                        task.environment === this.currentEnvironment && 
                        this.getTaskActualStatus(task) === 'pending'
                    ).length;
                },

                getFailedTasks() {
                    // 统计当前环境中有失败Cases的任务数
                    return this.tasks.filter(task => {
                        if (task.environment !== this.currentEnvironment) return false;
                        const stats = this.getTaskCaseStats(task.id);
                        return stats.failed > 0;
                    }).length;
                },

                // 获取任务的Cases
                getTaskCases(taskId) {
                    return this.cases.filter(c => c.taskId === taskId);
                },

                // 获取任务Case统计
                getTaskCaseStats(taskId) {
                    const taskCases = this.getTaskCases(taskId);
                    return {
                        total: taskCases.length,
                        success: taskCases.filter(c => c.status === 'success').length,
                        failed: taskCases.filter(c => c.status === 'failed').length,
                        processing: taskCases.filter(c => c.status === 'processing').length
                    };
                },

                // 获取已完成的Cases数量（只包含成功和失败）
                getCompletedCasesCount() {
                    if (!this.selectedTask) return 0;
                    const taskCases = this.getTaskCases(this.selectedTask.id);
                    return taskCases.filter(c => c.status === 'success' || c.status === 'failed').length;
                },

                // 获取过滤后的Cases（带搜索和分页）- 只显示成功和失败的
                getFilteredCases() {
                    if (!this.selectedTask) return [];
                    let taskCases = this.getTaskCases(this.selectedTask.id);
                    
                    // 只显示已完成的Cases（成功或失败）
                    taskCases = taskCases.filter(c => c.status === 'success' || c.status === 'failed');
                    
                    // 按创建时间倒序排列（最新的在最上面）
                    taskCases.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // 按状态过滤
                    if (this.caseFilter === 'success') {
                        taskCases = taskCases.filter(c => c.status === 'success');
                    } else if (this.caseFilter === 'failed') {
                        taskCases = taskCases.filter(c => c.status === 'failed');
                    }
                    
                    // 搜索过滤
                    if (this.searchKeyword.trim()) {
                        const keyword = this.searchKeyword.toLowerCase();
                        taskCases = taskCases.filter(c => {
                            const paramsStr = JSON.stringify(c.inputParams).toLowerCase();
                            const idStr = String(c.id).toLowerCase();
                            return paramsStr.includes(keyword) || idStr.includes(keyword);
                        });
                    }
                    
                    // 分页
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return taskCases.slice(start, end);
                },

                // 获取过滤后的总数（不分页）- 只统计成功和失败的
                getFilteredCasesTotal() {
                    if (!this.selectedTask) return [];
                    let taskCases = this.getTaskCases(this.selectedTask.id);
                    
                    // 只显示已完成的Cases（成功或失败）
                    taskCases = taskCases.filter(c => c.status === 'success' || c.status === 'failed');
                    
                    if (this.caseFilter === 'success') {
                        taskCases = taskCases.filter(c => c.status === 'success');
                    } else if (this.caseFilter === 'failed') {
                        taskCases = taskCases.filter(c => c.status === 'failed');
                    }
                    
                    if (this.searchKeyword.trim()) {
                        const keyword = this.searchKeyword.toLowerCase();
                        taskCases = taskCases.filter(c => {
                            const paramsStr = JSON.stringify(c.inputParams).toLowerCase();
                            const idStr = String(c.id).toLowerCase();
                            return paramsStr.includes(keyword) || idStr.includes(keyword);
                        });
                    }
                    
                    return taskCases;
                },

                // 获取总页数
                getTotalPages() {
                    const total = this.getFilteredCasesTotal().length;
                    return Math.max(1, Math.ceil(total / this.pageSize));
                },

                // 获取当前过滤条件下的显示文本
                getCurrentFilterText() {
                    if (!this.selectedTask) return '';
                    const stats = this.getTaskCaseStats(this.selectedTask.id);
                    const completedCount = stats.success + stats.failed; // 只统计已完成的（成功+失败）
                    
                    if (this.caseFilter === 'success') {
                        return `共 ${stats.success} 条成功 Case`;
                    } else if (this.caseFilter === 'failed') {
                        return `共 ${stats.failed} 条失败 Case`;
                    }
                    return `共 ${completedCount} 条 Case`;
                },

                // 获取任务的实际状态
                getTaskActualStatus(task) {
                    const taskCases = this.getTaskCases(task.id);
                    const caseCount = taskCases.length;
                    
                    // 1. 如果用户标记为已完成
                    if (task.isCompleted) {
                        // 检查是否有新增的case（如果标记完成后又有新case，自动变为运行中）
                        const hasNewCases = taskCases.some(c => {
                            // 如果有任何pending或processing的case，说明有新的处理任务
                            return c.status === 'pending' || c.status === 'processing';
                        });
                        
                        if (hasNewCases) {
                            // 自动取消已完成标记
                            task.isCompleted = false;
                            return 'running';
                        }
                        
                        return 'completed';
                    }
                    
                    // 2. 如果有cases，则为运行中
                    if (caseCount > 0) {
                        return 'running';
                    }
                    
                    // 3. 否则为等待中（任务创建了但还没有case）
                    return 'pending';
                },

                // 任务状态样式
                getTaskStatusClass(task) {
                    const status = this.getTaskActualStatus(task);
                    const classes = {
                        'running': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'pending': 'bg-yellow-100 text-yellow-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                // 任务状态文本
                getTaskStatusText(task) {
                    const status = this.getTaskActualStatus(task);
                    const texts = {
                        'running': '运行中',
                        'completed': '已完成',
                        'pending': '等待中'
                    };
                    return texts[status] || '未知';
                },

                // 环境相关
                getEnvironmentClass(environment) {
                    const classes = {
                        'none': 'bg-gray-100 text-gray-800',
                        'gray': 'bg-orange-100 text-orange-800',
                        'production': 'bg-green-100 text-green-800'
                    };
                    return classes[environment] || 'bg-gray-100 text-gray-800';
                },

                getEnvironmentText(environment) {
                    const texts = {
                        'none': '未部署',
                        'gray': '灰度环境',
                        'production': '线上环境'
                    };
                    return texts[environment] || '未部署';
                },

                updateEnvironment(task, environment) {
                    const taskIndex = this.tasks.findIndex(t => t.id === task.id);
                    if (taskIndex !== -1) {
                        const updatedTask = {
                            ...this.tasks[taskIndex],
                            environment: environment
                        };
                        this.tasks.splice(taskIndex, 1, updatedTask);
                        
                        const envText = environment === 'gray' ? '灰度环境' : '线上环境';
                        alert(`任务"${task.name}"已成功更新到${envText}！`);
                    }
                },

                // Case状态相关（保持原有逻辑）
                getStatusClass(status) {
                    const classes = {
                        'running': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800',
                        'pending': 'bg-yellow-100 text-yellow-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                getStatusText(status) {
                    const texts = {
                        'running': '运行中',
                        'completed': '已完成',
                        'failed': '失败',
                        'pending': '等待中'
                    };
                    return texts[status] || '未知';
                },

                getCaseStatusClass(status) {
                    const classes = {
                        'success': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800',
                        'processing': 'bg-blue-100 text-blue-800',
                        'pending': 'bg-yellow-100 text-yellow-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                getCaseStatusText(status) {
                    const texts = {
                        'success': '成功',
                        'failed': '失败',
                        'processing': '处理中',
                        'pending': '等待中'
                    };
                    return texts[status] || '未知';
                },

                formatDate(date) {
                    return new Date(date).toLocaleString('zh-CN');
                },

                formatInputParams(params) {
                    return Object.entries(params).map(([k, v]) => `${k}: ${v}`).join(', ');
                },

                // 视图切换
                viewTaskDetail(taskId) {
                    this.selectedTask = this.tasks.find(t => t.id === taskId);
                    this.currentView = 'detail';
                    this.caseFilter = 'all';
                    this.searchKeyword = '';
                    this.currentPage = 1;
                },

                backToList() {
                    this.currentView = 'list';
                    this.selectedTask = null;
                    this.searchKeyword = '';
                    this.currentPage = 1;
                },

                // 环境管理
                selectEnvironment(env) {
                    this.currentEnvironment = env;
                    this.currentView = 'list';
                },

                switchEnvironment() {
                    if (confirm('切换环境将返回到环境选择页面，当前页面数据不会丢失。确定要切换吗？')) {
                        this.currentView = 'envSelect';
                        this.currentEnvironment = null;
                    }
                },

                // 获取当前环境的任务
                getCurrentEnvironmentTasks() {
                    return this.tasks.filter(task => task.environment === this.currentEnvironment);
                },

                // 任务管理
                addInputField() {
                    this.currentTask.inputFields.push({ name: '', type: 'string' });
                },

                removeInputField(index) {
                    this.currentTask.inputFields.splice(index, 1);
                },

                addOutputField() {
                    this.currentTask.outputFields.push({ name: '', type: 'string' });
                },

                removeOutputField(index) {
                    this.currentTask.outputFields.splice(index, 1);
                },

                saveTask() {
                    // 验证必填字段
                    if (!this.currentTask.name || !this.currentTask.difyUrl || !this.currentTask.difyKey) {
                        alert('请填写任务名称、API URL和API Key');
                        return;
                    }
                    
                    if (this.currentTask.inputFields.length === 0) {
                        alert('请至少添加一个入参字段');
                        return;
                    }
                    
                    if (this.currentTask.outputFields.length === 0) {
                        alert('请至少添加一个出参字段');
                        return;
                    }
                    
                    // 验证所有字段都有名称和类型
                    const invalidInputFields = this.currentTask.inputFields.some(f => !f.name || !f.type);
                    const invalidOutputFields = this.currentTask.outputFields.some(f => !f.name || !f.type);
                    
                    if (invalidInputFields || invalidOutputFields) {
                        alert('请完整填写所有字段的名称和类型');
                        return;
                    }
                    
                    if (this.showEditModal) {
                        const index = this.tasks.findIndex(task => task.id === this.editingTaskId);
                        if (index !== -1) {
                            this.tasks[index] = {
                                ...this.tasks[index],
                                ...this.currentTask,
                                retryCount: 0
                            };
                        }
                    } else {
                        const newTask = {
                            ...this.currentTask,
                            id: Date.now(),
                            retryCount: 0,
                            maxRetries: 3,
                            isCompleted: false,
                            environment: this.currentEnvironment, // 新任务分配到当前环境
                            createdAt: new Date()
                        };
                        this.tasks.push(newTask);
                        // 创建完新任务后，tab自动锚定到【全部】
                        this.taskStatusFilter = 'all';
                    }
                    this.closeModal();
                },

                // 切换任务完成状态
                toggleTaskCompletion(task) {
                    const taskIndex = this.tasks.findIndex(t => t.id === task.id);
                    if (taskIndex !== -1) {
                        // 创建新对象以触发响应式更新
                        const updatedTask = {
                            ...this.tasks[taskIndex],
                            isCompleted: !this.tasks[taskIndex].isCompleted
                        };
                        // 使用splice替换整个对象，确保触发响应式
                        this.tasks.splice(taskIndex, 1, updatedTask);
                    }
                },

                editTask(task) {
                    this.currentTask = { ...task };
                    this.editingTaskId = task.id;
                    this.showEditModal = true;

                },

                deleteTask(taskId) {
                    if (confirm('确定要删除这个任务吗？这将同时删除该任务下的所有数据。')) {
                        this.tasks = this.tasks.filter(task => task.id !== taskId);
                        this.cases = this.cases.filter(c => c.taskId !== taskId);
                    }
                },

                closeModal() {
                    this.showCreateModal = false;
                    this.showEditModal = false;
                    this.currentTask = {
                        name: '',
                        description: '',
                        difyUrl: '',
                        difyKey: '',
                        inputFields: [],
                        outputFields: []
                    };
                    this.editingTaskId = null;
                },

                // Case管理
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.uploadBatch.fileName = file.name;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            // 验证Excel字段是否与任务定义的入参匹配
                            if (jsonData.length > 0 && this.selectedTask) {
                                const excelFields = Object.keys(jsonData[0]);
                                const requiredFields = this.selectedTask.inputFields.map(f => f.name);
                                
                                // 检查所有必需字段是否都存在
                                const missingFields = requiredFields.filter(field => !excelFields.includes(field));
                                
                                if (missingFields.length > 0) {
                                    alert(`Excel文件字段不匹配！\n缺少以下字段：${missingFields.join(', ')}\n\n任务要求的入参字段：${requiredFields.join(', ')}\nExcel文件的字段：${excelFields.join(', ')}`);
                                    this.removeUploadedFile();
                                    return;
                                }
                            }
                            
                            this.uploadBatch.data = jsonData;
                            this.uploadBatch.rowCount = jsonData.length;
                        } catch (error) {
                            alert('Excel文件解析失败：' + error.message);
                            this.removeUploadedFile();
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },

                removeUploadedFile() {
                    this.uploadBatch.fileName = '';
                    this.uploadBatch.rowCount = 0;
                    this.uploadBatch.data = [];
                    // 清空文件输入
                    const fileInput = document.getElementById('file-upload');
                    if (fileInput) fileInput.value = '';
                },

                uploadCases() {
                    if (!this.selectedTask || this.uploadBatch.data.length === 0) {
                        alert('请先上传有效的Excel文件');
                        return;
                    }

                    // 创建新的Cases
                    const batchName = `批次_${new Date().toLocaleString('zh-CN')}`;
                    const newCases = this.uploadBatch.data.map((row, index) => ({
                        id: Date.now() + index,
                        taskId: this.selectedTask.id,
                        batchName: batchName,
                        inputParams: row,
                        outputData: null,
                        status: 'pending',
                        retryCount: 0,
                        maxRetries: parseInt(this.uploadBatch.maxRetries),
                        createdAt: new Date(),
                        completedAt: null,
                        error: null
                    }));

                    this.cases.push(...newCases);

                    // 初始化进度
                    this.taskProgress = {
                        show: true,
                        total: newCases.length,
                        processed: 0,
                        success: 0,
                        failed: 0,
                        processing: 0,
                        stopped: false
                    };

                    // 模拟处理（带并发控制）
                    const concurrency = parseInt(this.uploadBatch.concurrency);
                    this.processCasesWithConcurrency(newCases, concurrency);

                    // 重置上传表单
                    this.uploadBatch = {
                        maxRetries: 3,
                        concurrency: 5,
                        fileName: '',
                        rowCount: 0,
                        data: []
                    };
                    this.showUploadModal = false;

                    alert(`成功上传 ${newCases.length} 个Cases，正在处理中...`);
                },

                processCasesWithConcurrency(cases, concurrency) {
                    let currentIndex = 0;
                    let activeCount = 0;

                    const processNext = () => {
                        // 检查是否已停止
                        if (this.taskProgress.stopped) {
                            // 将所有未处理的case标记为pending
                            for (let i = currentIndex; i < cases.length; i++) {
                                if (cases[i].status === 'processing') {
                                    const caseIndex = this.cases.findIndex(c => c.id === cases[i].id);
                                    if (caseIndex !== -1) {
                                        this.cases[caseIndex].status = 'pending';
                                    }
                                }
                            }
                            this.taskProgress.processing = 0;
                            return;
                        }

                        while (activeCount < concurrency && currentIndex < cases.length && !this.taskProgress.stopped) {
                            const caseItem = cases[currentIndex++];
                            activeCount++;
                            
                            // 更新case状态为processing（通过cases数组来触发响应式）
                            const caseIndex = this.cases.findIndex(c => c.id === caseItem.id);
                            if (caseIndex !== -1) {
                                this.cases[caseIndex].status = 'processing';
                            }
                            this.taskProgress.processing++;

                            // 模拟异步处理
                            setTimeout(() => {
                                // 再次检查是否已停止
                                if (this.taskProgress.stopped) {
                                    const idx = this.cases.findIndex(c => c.id === caseItem.id);
                                    if (idx !== -1) {
                                        this.cases[idx].status = 'pending';
                                    }
                                    this.taskProgress.processing--;
                                    activeCount--;
                                    return;
                                }

                                const success = Math.random() > 0.2; // 80%成功率
                                
                                // 找到对应的case并更新（触发响应式更新）
                                const idx = this.cases.findIndex(c => c.id === caseItem.id);
                                if (idx !== -1) {
                                    this.cases[idx].status = success ? 'success' : 'failed';
                                    
                                    if (success) {
                                        this.cases[idx].outputData = {
                                            result: '模拟生成的结果数据',
                                            generated_at: new Date().toISOString()
                                        };
                                        this.cases[idx].completedAt = new Date();
                                        this.taskProgress.success++;
                                    } else {
                                        this.cases[idx].error = '模拟API调用失败';
                                        this.taskProgress.failed++;
                                    }
                                }

                                this.taskProgress.processing--;
                                this.taskProgress.processed++;
                                activeCount--;

                                // 检查是否所有任务完成或已停止
                                if (this.taskProgress.processed >= this.taskProgress.total) {
                                    // 所有任务完成，显示统计弹窗
                                    setTimeout(() => {
                                        this.taskProgress.show = false;
                                        
                                        // 设置完成统计数据
                                        this.completionStats = {
                                            total: this.taskProgress.total,
                                            success: this.taskProgress.success,
                                            failed: this.taskProgress.failed
                                        };
                                        
                                        // 显示完成统计弹窗
                                        this.showCompletionModal = true;
                                    }, 1000); // 1秒后显示统计弹窗
                                } else if (this.taskProgress.stopped) {
                                    // 用户停止了处理
                                    setTimeout(() => {
                                        this.taskProgress.show = false;
                                    }, 3000);
                                }

                                if (!this.taskProgress.stopped) {
                                    processNext();
                                }
                            }, Math.random() * 2000 + 1000); // 1-3秒随机延迟
                        }
                    };

                    processNext();
                },

                // 停止处理
                stopProcessing() {
                    if (confirm('确定要停止当前任务处理吗？未处理的Cases将保持待处理状态。')) {
                        this.taskProgress.stopped = true;
                        alert('正在停止任务处理...');
                    }
                },

                // 继续处理
                continueProcessing() {
                    if (!this.selectedTask) return;
                    
                    // 获取待处理的Cases
                    const pendingCases = this.getTaskCases(this.selectedTask.id)
                        .filter(c => c.status === 'pending');
                    
                    if (pendingCases.length === 0) {
                        alert('没有待处理的Cases！');
                        return;
                    }
                    
                    // 重置停止标志
                    this.taskProgress.stopped = false;
                    
                    // 使用原来的并发设置继续处理
                    const concurrency = 5; // 默认并发数
                    this.processCasesWithConcurrency(pendingCases, concurrency);
                    
                    alert(`继续处理 ${pendingCases.length} 个待处理的Cases...`);
                },

                // 删除待处理的Cases
                deletePendingCases() {
                    if (!this.selectedTask) return;
                    
                    const pendingCases = this.getTaskCases(this.selectedTask.id)
                        .filter(c => c.status === 'pending');
                    
                    if (pendingCases.length === 0) {
                        alert('没有待处理的Cases！');
                        return;
                    }
                    
                    if (confirm(`确定要删除 ${pendingCases.length} 个待处理的Cases吗？此操作不可恢复！`)) {
                        // 删除待处理的Cases
                        const pendingIds = pendingCases.map(c => c.id);
                        this.cases = this.cases.filter(c => !pendingIds.includes(c.id));
                        
                        // 更新进度
                        this.taskProgress.total = this.taskProgress.processed;
                        
                        // 隐藏进度条
                        setTimeout(() => {
                            this.taskProgress.show = false;
                        }, 2000);
                        
                        alert(`成功删除 ${pendingCases.length} 个待处理的Cases！`);
                    }
                },

                viewCaseDetail(caseItem) {
                    this.selectedCase = caseItem;
                    this.editingOutput = false;
                    this.editingOutputData = '';
                    this.showCaseDetailModal = true;
                },

                // 切换编辑输出模式
                toggleEditOutput() {
                    this.editingOutput = !this.editingOutput;
                    if (this.editingOutput && this.selectedCase && this.selectedCase.outputData) {
                        // 进入编辑模式时，将当前输出数据格式化为JSON字符串
                        this.editingOutputData = JSON.stringify(this.selectedCase.outputData, null, 2);
                    }
                },

                // 取消编辑输出
                cancelEditOutput() {
                    this.editingOutput = false;
                    this.editingOutputData = '';
                },

                // 保存编辑的输出
                saveEditOutput() {
                    if (!this.selectedCase) return;
                    
                    try {
                        // 验证JSON格式
                        const parsedData = JSON.parse(this.editingOutputData);
                        
                        // 找到对应的case并更新
                        const caseIndex = this.cases.findIndex(c => c.id === this.selectedCase.id);
                        if (caseIndex !== -1) {
                            this.cases[caseIndex].outputData = parsedData;
                            this.selectedCase.outputData = parsedData;
                            
                            alert('输出结果已成功保存！');
                            this.editingOutput = false;
                            this.editingOutputData = '';
                        }
                    } catch (error) {
                        alert('JSON格式错误，请检查后重试！\n错误信息：' + error.message);
                    }
                },

                // 计算成功率
                getSuccessRate() {
                    if (this.completionStats.total === 0) return 0;
                    return Math.round((this.completionStats.success / this.completionStats.total) * 100);
                },

                regenerateCase(caseId, showProgress = true) {
                    const caseIndex = this.cases.findIndex(c => c.id === caseId);
                    if (caseIndex === -1) return;

                    const caseItem = this.cases[caseIndex];
                    if (caseItem.retryCount >= caseItem.maxRetries) {
                        alert('已达到最大重试次数！');
                        return;
                    }

                    // 如果是单个重新生成，显示进度条
                    if (showProgress) {
                        this.taskProgress = {
                            show: true,
                            total: 1,
                            processed: 0,
                            success: 0,
                            failed: 0,
                            processing: 1,
                            stopped: false
                        };
                    }

                    // 通过索引更新以触发响应式
                    this.cases[caseIndex].status = 'processing';
                    this.cases[caseIndex].retryCount++;
                    this.cases[caseIndex].error = null;

                    // 模拟重新处理
                    setTimeout(() => {
                        const success = Math.random() > 0.3;
                        const idx = this.cases.findIndex(c => c.id === caseId);
                        if (idx !== -1) {
                            this.cases[idx].status = success ? 'success' : 'failed';
                            
                            if (success) {
                                this.cases[idx].outputData = {
                                    result: '重新生成的结果数据',
                                    generated_at: new Date().toISOString()
                                };
                                this.cases[idx].completedAt = new Date();
                                
                                // 更新进度统计
                                if (showProgress) {
                                    this.taskProgress.success++;
                                }
                            } else {
                                this.cases[idx].error = '重试失败';
                                
                                // 更新进度统计
                                if (showProgress) {
                                    this.taskProgress.failed++;
                                }
                            }
                            
                            // 更新进度条
                            if (showProgress) {
                                this.taskProgress.processing--;
                                this.taskProgress.processed++;
                                
                                // 3秒后隐藏进度条
                                setTimeout(() => {
                                    this.taskProgress.show = false;
                                }, 3000);
                            }
                        }
                    }, 2000);
                },

                // 批量重试所有失败的Cases
                regenerateAllFailed() {
                    if (!this.selectedTask) return;
                    
                    const failedCases = this.getTaskCases(this.selectedTask.id)
                        .filter(c => c.status === 'failed' && c.retryCount < c.maxRetries);
                    
                    if (failedCases.length === 0) {
                        alert('没有可重试的失败Cases！');
                        return;
                    }
                    
                    if (!confirm(`确定要重试 ${failedCases.length} 个失败的Cases吗？`)) {
                        return;
                    }
                    
                    // 初始化进度条
                    this.taskProgress = {
                        show: true,
                        total: failedCases.length,
                        processed: 0,
                        success: 0,
                        failed: 0,
                        processing: 0,
                        stopped: false
                    };
                    
                    // 使用并发处理重新生成
                    const concurrency = 5; // 默认并发数
                    this.regenerateCasesWithConcurrency(failedCases, concurrency);
                    
                    alert(`开始重试 ${failedCases.length} 个失败的Cases...`);
                },

                // 并发重新生成Cases
                regenerateCasesWithConcurrency(cases, concurrency) {
                    let currentIndex = 0;
                    let activeCount = 0;

                    const processNext = () => {
                        // 检查是否已停止
                        if (this.taskProgress.stopped) {
                            this.taskProgress.processing = 0;
                            return;
                        }

                        while (activeCount < concurrency && currentIndex < cases.length && !this.taskProgress.stopped) {
                            const caseItem = cases[currentIndex++];
                            
                            // 检查是否已达到最大重试次数
                            if (caseItem.retryCount >= caseItem.maxRetries) {
                                this.taskProgress.processed++;
                                this.taskProgress.failed++;
                                continue;
                            }
                            
                            activeCount++;
                            
                            // 更新case状态为processing
                            const caseIndex = this.cases.findIndex(c => c.id === caseItem.id);
                            if (caseIndex !== -1) {
                                this.cases[caseIndex].status = 'processing';
                                this.cases[caseIndex].retryCount++;
                                this.cases[caseIndex].error = null;
                            }
                            this.taskProgress.processing++;

                            // 模拟异步处理
                            setTimeout(() => {
                                // 再次检查是否已停止
                                if (this.taskProgress.stopped) {
                                    const idx = this.cases.findIndex(c => c.id === caseItem.id);
                                    if (idx !== -1) {
                                        this.cases[idx].status = 'failed';
                                        this.cases[idx].error = '用户停止处理';
                                    }
                                    this.taskProgress.processing--;
                                    activeCount--;
                                    return;
                                }

                                const success = Math.random() > 0.3; // 70%成功率
                                
                                // 找到对应的case并更新
                                const idx = this.cases.findIndex(c => c.id === caseItem.id);
                                if (idx !== -1) {
                                    this.cases[idx].status = success ? 'success' : 'failed';
                                    
                                    if (success) {
                                        this.cases[idx].outputData = {
                                            result: '重新生成的结果数据',
                                            generated_at: new Date().toISOString()
                                        };
                                        this.cases[idx].completedAt = new Date();
                                        this.taskProgress.success++;
                                    } else {
                                        this.cases[idx].error = '重试失败';
                                        this.taskProgress.failed++;
                                    }
                                }

                                this.taskProgress.processing--;
                                this.taskProgress.processed++;
                                activeCount--;

                                // 检查是否所有任务完成或已停止
                                if (this.taskProgress.processed >= this.taskProgress.total) {
                                    // 所有任务完成，显示统计弹窗
                                    setTimeout(() => {
                                        this.taskProgress.show = false;
                                        
                                        // 设置完成统计数据
                                        this.completionStats = {
                                            total: this.taskProgress.total,
                                            success: this.taskProgress.success,
                                            failed: this.taskProgress.failed
                                        };
                                        
                                        // 显示完成统计弹窗
                                        this.showCompletionModal = true;
                                    }, 1000); // 1秒后显示统计弹窗
                                } else if (this.taskProgress.stopped) {
                                    // 用户停止了处理
                                    setTimeout(() => {
                                        this.taskProgress.show = false;
                                    }, 3000);
                                }

                                if (!this.taskProgress.stopped) {
                                    processNext();
                                }
                            }, Math.random() * 2000 + 1000); // 1-3秒随机延迟
                        }
                    };

                    processNext();
                },

                // 导出Cases到Excel
                exportCases() {
                    if (!this.selectedTask) return;
                    
                    const taskCases = this.getTaskCases(this.selectedTask.id);
                    
                    if (taskCases.length === 0) {
                        alert('没有可导出的Cases！');
                        return;
                    }
                    
                    // 准备导出数据
                    const exportData = taskCases.map(c => {
                        const row = {
                            'Case ID': c.id,
                            '状态': this.getCaseStatusText(c.status),
                            '重试次数': `${c.retryCount}/${c.maxRetries}`,
                            '创建时间': this.formatDate(c.createdAt),
                            ...c.inputParams
                        };
                        
                        // 添加输出数据
                        if (c.outputData) {
                            Object.entries(c.outputData).forEach(([key, value]) => {
                                row[`输出_${key}`] = typeof value === 'object' ? JSON.stringify(value) : value;
                            });
                        }
                        
                        // 添加错误信息
                        if (c.error) {
                            row['错误信息'] = c.error;
                        }
                        
                        return row;
                    });
                    
                    // 创建工作簿
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Cases');
                    
                    // 下载文件
                    const fileName = `${this.selectedTask.name}_cases_${new Date().getTime()}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    alert(`成功导出 ${taskCases.length} 条Cases数据！`);
                },

                // 清除Case的环境数据
                clearCaseEnvironmentData(caseId) {
                    const caseIndex = this.cases.findIndex(c => c.id === caseId);
                    if (caseIndex === -1) {
                        alert('Case未找到！');
                        return;
                    }
                    
                    const caseItem = this.cases[caseIndex];
                    const task = this.tasks.find(t => t.id === caseItem.taskId);
                    
                    if (!task) {
                        alert('任务未找到！');
                        return;
                    }
                    
                    // 获取当前环境名称
                    const envName = task.environment === 'gray' ? '灰度环境' : '线上环境';
                    
                    // 显示确认对话框
                    const confirmMessage = `确定要清除以下Case在${envName}的数据吗？\n\n` +
                        `Case ID: #${caseItem.id}\n` +
                        `入参: ${this.formatInputParams(caseItem.inputParams)}\n` +
                        `状态: ${this.getCaseStatusText(caseItem.status)}\n\n` +
                        `此操作将：\n` +
                        `1. 删除该Case在系统中的记录\n` +
                        `2. 清除相关的输出数据和状态\n\n` +
                        `此操作不可恢复，是否继续？`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // 模拟调用API清除环境数据（实际场景中这里应该调用后端API）
                    // 这里可以根据实际需求添加调用Dify API或其他清理逻辑
                    
                    // 从数组中删除该Case
                    this.cases.splice(caseIndex, 1);
                    
                    // 显示成功消息
                    alert(`成功清除Case #${caseId} 在${envName}的数据！\n\n` +
                        `已删除的内容：\n` +
                        `- Case记录\n` +
                        `- 输入参数\n` +
                        `- 输出数据\n` +
                        `- 执行状态`);
                    
                    // 如果当前页没有数据了，返回上一页
                    if (this.getFilteredCases().length === 0 && this.currentPage > 1) {
                        this.currentPage--;
                    }
                }
            }
        }
    </script>
</body>
</html>